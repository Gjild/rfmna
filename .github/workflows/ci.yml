name: ci
on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    env:
      CI: "true"
      PYTHONHASHSEED: "0"
      OPENBLAS_NUM_THREADS: "1"
      MKL_NUM_THREADS: "1"
      OMP_NUM_THREADS: "1"
      NUMEXPR_NUM_THREADS: "1"
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Set up Python
        run: uv python install 3.14

      - name: Sync
        run: uv sync --all-groups

      - name: Lint
        run: uv run ruff check .

      - name: Type check
        run: uv run mypy src

      - name: Resolve governance diff range
        shell: bash
        run: |
          ZERO_SHA="0000000000000000000000000000000000000000"
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            gov_base="${{ github.event.pull_request.base.sha }}"
          else
            gov_base="${{ github.event.before }}"
          fi
          if [ -z "$gov_base" ] || [ "$gov_base" = "$ZERO_SHA" ] || ! git rev-parse --verify --quiet "${gov_base}^{commit}" >/dev/null; then
            if git rev-parse --verify --quiet "${{ github.sha }}^" >/dev/null; then
              gov_base="$(git rev-parse "${{ github.sha }}^")"
            else
              gov_base="${{ github.sha }}"
            fi
          fi
          echo "RFMNA_GOV_BASE=$gov_base" >> "$GITHUB_ENV"
          echo "RFMNA_GOV_HEAD=${{ github.sha }}" >> "$GITHUB_ENV"

      - name: Phase 2 governance sub-gate (blocking)
        run: |
          uv run python -m rfmna.governance.phase2_gate \
            --sub-gate governance \
            --base-ref "$RFMNA_GOV_BASE" \
            --head-ref "$RFMNA_GOV_HEAD" \
            --report-file phase2_governance_subgate_status.txt

      - name: Phase 2 category bootstrap sub-gate (blocking)
        run: |
          uv run python -m rfmna.governance.phase2_gate \
            --sub-gate category-bootstrap \
            --report-file phase2_category_bootstrap_subgate_status.txt

      - name: Audit AGENTS Phase 2 cross_check policy alignment
        run: |
          if ! grep -Fq '`cross_check` (mandatory for Phase 2 robustness work' AGENTS.md; then
            echo "AGENTS.md no longer states cross_check as mandatory for Phase 2 robustness work."
            echo "Open a separate governance-labeled task/PR to resolve policy drift; do not bundle AGENTS.md edits into P2-09 implementation changes."
            exit 1
          fi

      - name: Prepare test report directory
        run: mkdir -p test-reports

      - name: Tests (acceptance baseline)
        run: uv run pytest -q

      - name: Tests (unit collection guard)
        run: uv run pytest -m unit --collect-only -q

      - name: Tests (unit)
        run: uv run pytest -m unit --junitxml=test-reports/unit.xml

      - name: Tests (conformance collection guard)
        run: uv run pytest -m conformance --collect-only -q

      - name: Tests (thread-controls conformance guard)
        run: |
          uv run pytest \
            tests/conformance/test_thread_controls_conformance.py::test_ci_workflow_declares_deterministic_thread_defaults \
            tests/conformance/test_thread_controls_conformance.py::test_envrc_declares_deterministic_thread_defaults \
            -m conformance \
            --junitxml=test-reports/thread_controls_conformance.xml

      - name: Tests (conformance)
        run: uv run pytest -m conformance --junitxml=test-reports/conformance.xml

      - name: Tests (property collection guard)
        run: uv run pytest -m property --collect-only -q

      - name: Tests (property)
        run: uv run pytest -m property --junitxml=test-reports/property.xml

      - name: Tests (regression collection guard)
        run: uv run pytest -m regression --collect-only -q

      - name: Tests (regression)
        run: uv run pytest -m regression --junitxml=test-reports/regression.xml

      - name: Tests (regression scaffold selector)
        run: uv run pytest tests/regression -m regression -q

      - name: Tests (cross_check collection guard)
        run: uv run pytest -m cross_check --collect-only -q

      - name: Tests (cross_check)
        run: uv run pytest -m cross_check --junitxml=test-reports/cross_check.xml

      - name: Import smoke
        run: uv run python -c "import rfmna"

      - name: CLI smoke
        run: uv run rfmna --help

      - name: Upload calibration/regression/cross_check diagnostics (failure)
        if: ${{ failure() }}
        uses: actions/upload-artifact@v4
        with:
          name: phase2-calibration-regression-cross-check-diagnostics
          path: |
            test-reports/regression.xml
            test-reports/cross_check.xml
            docs/dev/p2_08_calibration_report.md
            docs/dev/cross_check_reference_tolerance_policy.md
            docs/dev/tolerances/calibration_seed_v1.yaml
            docs/dev/tolerances/regression_baseline_v1.yaml
            tests/fixtures/cross_check/approved_hashes_v1.json
            tests/fixtures/cross_check/*.json
          if-no-files-found: warn

      - name: Phase 1 gate status (informational)
        if: ${{ always() }}
        run: |
          echo "task=P1-00"
          echo "checklist=docs/dev/phase1_gate.md"
          if test -f docs/dev/phase1_gate.md; then
            echo "checklist_status=present"
            sed -n '1,220p' docs/dev/phase1_gate.md
          else
            echo "checklist_status=missing"
          fi
          {
            echo "task=P1-00"
            echo "checklist=docs/dev/phase1_gate.md"
            if test -f docs/dev/phase1_gate.md; then
              echo "checklist_status=present"
            else
              echo "checklist_status=missing"
            fi
          } > phase1_gate_status.txt

      - name: Upload Phase 1 gate status (informational)
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: phase1-gate-status
          path: |
            phase1_gate_status.txt
            docs/dev/phase1_gate.md
          if-no-files-found: warn

      - name: Phase 2 gate status (informational)
        if: ${{ always() }}
        run: |
          echo "task=P2-00"
          echo "checklist=docs/dev/phase2_gate.md"
          if test -f docs/dev/phase2_gate.md; then
            echo "checklist_status=present"
            sed -n '1,260p' docs/dev/phase2_gate.md
          else
            echo "checklist_status=missing"
          fi
          {
            echo "task=P2-00"
            echo "checklist=docs/dev/phase2_gate.md"
            if test -f docs/dev/phase2_gate.md; then
              echo "checklist_status=present"
            else
              echo "checklist_status=missing"
            fi
          } > phase2_gate_status.txt

      - name: Upload Phase 2 gate status (informational)
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: phase2-gate-status
          path: |
            phase2_gate_status.txt
            phase2_governance_subgate_status.txt
            phase2_category_bootstrap_subgate_status.txt
            docs/dev/phase2_gate.md
          if-no-files-found: warn
